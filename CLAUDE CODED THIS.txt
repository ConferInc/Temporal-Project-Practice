❯ /compact
  Context: The system works, but feels "empty" in later stages, and the UX allows signing without reading.

  ## Mission 1: UX Fix - "Read before Signing"
  **Target:** `frontend/src/pages/ApplicantDashboard.jsx`
  1.  **Add State:** `const [hasViewed, setHasViewed] = useState(false)`.
  2.  **Update "View Disclosures" Button:**
  * `onClick`: Open the PDF URL **AND** `setHasViewed(true)`.
  3.  **Update "Sign Documents" Button:**
  * **Condition:** Only show (or enable) if `needsSignature()` AND `hasViewed` are both true.
  * **UI:** If `needsSignature()` is true but `!hasViewed`, show a message: "⚠️ Please view disclosures to
  enable signing."

  ## Mission 2: Activate "Processing" Phase Tools
  **Target:** `backend/app/temporal/workflows/managers.py` (`ProcessingWorkflow`)
  1.  **Add Activity:** Call `send_email` (from `mcp_comms`).
  * Trigger: After `generate_document` succeeds.
  * Subject: "Action Required: Your Loan Disclosures are Ready".
  * Body: "Please log in to sign your documents."

  ## Mission 3: Activate "Underwriting" Phase Tools
  **Target:** `backend/app/temporal/workflows/managers.py` (`UnderwritingWorkflow`)
  1.  **Add Activity:** Call `evaluate_risk` (from `mcp_underwriting` or `legacy`).
  * **Simulation:** Add a 5-second sleep inside this activity (in `mcp_underwriting.py`) to simulate a heavy
  external API call.
  * **Logs:** Ensure it logs "Checking Credit Score...", "Calculating DTI...", "Risk Assessment Complete".

  ## Mission 4: Activate "Closing" Phase Tools
  **Target:** `backend/app/temporal/workflows/ceo.py` (Closing Section)
  1.  **Add Activity:** Call `generate_document` to create `Final_Approval_Letter.pdf`.
  2.  **Add Activity:** Call `send_email` ("Congratulations! Your Loan is Funded.").

  ## Execution
  1. Fix the React UX to enforce document viewing.
  2. Add the `send_email` and `evaluate_risk` calls to the backend workflows to populate the logs.

● I'll start by reading the relevant files to understand the current implementation before making changes.

● Read(frontend\src\pages\ApplicantDashboard.jsx)
  ⎿  Read 407 lines

● Read(backend\app\temporal\workflows\managers.py)
  ⎿  Read 472 lines

● Read(backend\app\temporal\workflows\ceo.py)
  ⎿  Read 319 lines

● Now I'll read the mcp_underwriting.py file to understand the current activities and add the simulation for
  evaluate_risk.

● Read(backend\app\temporal\activities\mcp_underwriting.py)
  ⎿  Read 147 lines

● Now let me also check the mcp_docgen.py to understand the generate_document activity for the Closing phase:

● Read(backend\app\temporal\activities\mcp_docgen.py)
  ⎿  Read 197 lines

● Read(backend\app\temporal\activities\mcp_comms.py)
  ⎿  Read 73 lines

● Now I have a complete understanding of the codebase. Let me implement all four missions.

● Update(frontend\src\pages\ApplicantDashboard.jsx)
  ⎿  Added 8 lines
      132
      133  // Application Card Component
      134  function ApplicationCard({ app, onSign, signingId, onRefresh }) {
      135 +    // Track whether user has viewed the disclosures (required before signing)
      136 +    const [hasViewed, setHasViewed] = useState(false);
      137 +
      138      const needsSignature = () => {
      139          const s = app.status?.toLowerCase() || "";
      140          const stage = app.loan_stage?.toUpperCase() || "";
     ...
      148          );
      149      };
      150
      151 +    const handleViewDisclosures = () => {
      152 +        window.open(`${API_URL}/static/${app.workflow_id}/Initial_Disclosures.pdf`, '_blank');
      153 +        setHasViewed(true);
      154 +    };
      155 +
      156      const formatCurrency = (amount) => {
      157          const num = parseFloat(amount) || 0;
      158          return new Intl.NumberFormat('en-US', {

● Update(frontend\src\pages\ApplicantDashboard.jsx)
  ⎿  Added 50 lines, removed 10 lines
      238                      </button>
      239                  </div>
      240
      241 -                {/* Action Required Card */}
      241 +                {/* Action Required Card - Read before Signing UX */}
      242                  {needsSignature() && (
      243 -                    <ActionCard
      244 -                        title="Action Required: Sign Your Documents"
      245 -                        description="Your Initial Disclosures are ready. Please review and sign to pro
          -ceed to underwriting."
      246 -                        icon={PenTool}
      247 -                        action={() => onSign(app.workflow_id)}
      248 -                        actionLabel={signingId === app.workflow_id ? "Signing..." : "Sign Documents No
          -w"}
      249 -                        variant="warning"
      250 -                        loading={signingId === app.workflow_id}
      251 -                    />
      243 +                    <div className="space-y-4">
      244 +                        {/* Step 1: View Disclosures Button */}
      245 +                        <div className="flex items-center gap-3">
      246 +                            <button
      247 +                                onClick={handleViewDisclosures}
      248 +                                className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium t
          +ransition ${
      249 +                                    hasViewed
      250 +                                        ? 'bg-green-100 text-green-700 hover:bg-green-200'
      251 +                                        : 'bg-blue-600 text-white hover:bg-blue-700'
      252 +                                }`}
      253 +                            >
      254 +                                {hasViewed ? <CheckCircle size={16} /> : <Eye size={16} />}
      255 +                                {hasViewed ? 'Disclosures Viewed' : 'View Disclosures First'}
      256 +                            </button>
      257 +                            {hasViewed && (
      258 +                                <span className="text-green-600 text-sm font-medium flex items-center
          +gap-1">
      259 +                                    <CheckCircle size={14} />
      260 +                                    Ready to sign
      261 +                                </span>
      262 +                            )}
      263 +                        </div>
      264 +
      265 +                        {/* Step 2: Sign Documents - Only enabled after viewing */}
      266 +                        {hasViewed ? (
      267 +                            <ActionCard
      268 +                                title="Action Required: Sign Your Documents"
      269 +                                description="You've reviewed the disclosures. Click below to sign and
          +proceed to underwriting."
      270 +                                icon={PenTool}
      271 +                                action={() => onSign(app.workflow_id)}
      272 +                                actionLabel={signingId === app.workflow_id ? "Signing..." : "Sign Docu
          +ments Now"}
      273 +                                variant="warning"
      274 +                                loading={signingId === app.workflow_id}
      275 +                            />
      276 +                        ) : (
      277 +                            <div className="bg-orange-50 border-2 border-orange-200 rounded-2xl p-6">
      278 +                                <div className="flex items-start gap-4">
      279 +                                    <div className="w-14 h-14 bg-orange-400 text-white rounded-xl flex
          + items-center justify-center flex-shrink-0">
      280 +                                        <AlertCircle size={28} />
      281 +                                    </div>
      282 +                                    <div className="flex-1">
      283 +                                        <h3 className="text-lg font-bold text-gray-900">⚠️ Please View
          +Disclosures First</h3>
      284 +                                        <p className="text-gray-600 mt-1">
      285 +                                            You must review your Initial Disclosures before signing. C
          +lick the "View Disclosures First" button above to continue.
      286 +                                        </p>
      287 +                                    </div>
      288 +                                </div>
      289 +                            </div>
      290 +                        )}
      291 +                    </div>
      292                  )}
      293
      294                  {/* View Documents */}

● Now let me update the ProcessingWorkflow to add the email notification after generating documents (Mission 2):

● Update(backend\app\temporal\workflows\managers.py)
  ⎿  Added 20 lines, removed 1 line
      322          workflow.logger.info(f"Initial Disclosures generated: {doc_result.get('public_url')}")
      323          self._log("DocGen MCP", f"Initial Disclosures generated: {doc_result.get('public_url')}")
      324
      325 -        # Step 3: Document verification placeholder
      325 +        # Step 3: Send email notification that disclosures are ready
      326 +        applicant_email = applicant_info.get("email", "")
      327 +        if applicant_email:
      328 +            workflow.logger.info("Sending disclosures ready email...")
      329 +            self._log("Comms MCP", "Sending disclosures ready notification...")
      330 +
      331 +            await workflow.execute_activity(
      332 +                send_email,
      333 +                args=["disclosures_ready", applicant_email, {
      334 +                    "name": applicant_info.get("name", "Borrower"),
      335 +                    "document_url": doc_result.get("public_url"),
      336 +                    "subject": "Action Required: Your Loan Disclosures are Ready"
      337 +                }],
      338 +                start_to_close_timeout=timedelta(seconds=30)
      339 +            )
      340 +
      341 +            workflow.logger.info(f"Disclosures ready email sent to {applicant_email}")
      342 +            self._log("Comms MCP", f"Email sent to {applicant_email}: Your disclosures are ready for r
          +eview and signature")
      343 +
      344 +        # Step 4: Document verification placeholder
      345          workflow.logger.info("Verifying documents...")
      346          self.status = "Verifying Documents"
      347          self._log("Processing Manager", "Document verification in progress...")

● Now let me update the mcp_underwriting.py to add the 5-second simulation with proper logging for evaluate_risk
  (Mission 3):

● Update(backend\app\temporal\activities\mcp_underwriting.py)
  ⎿  Added 1 line
      11  In production, integrate with actual underwriting systems.
      12  """
      13  import os
      14 +import asyncio
      15  from dataclasses import dataclass
      16  from temporalio import activity
      17  from datetime import datetime

● Update(backend\app\temporal\activities\mcp_underwriting.py)
  ⎿  Added 22 lines, removed 1 line
      143
      144  @activity.defn
      145  async def evaluate_risk(loan_data: dict) -> dict:
      146 -    """Temporal Activity: Evaluate loan risk via UnderwritingMCP"""
      146 +    """
      147 +    Temporal Activity: Evaluate loan risk via UnderwritingMCP
      148 +
      149 +    Simulates external API calls with detailed logging for visibility.
      150 +    """
      151 +    timestamp = datetime.utcnow().isoformat()
      152 +
      153 +    # Simulate checking credit score (external API call)
      154 +    print(f"[UnderwritingMCP] [{timestamp}] Checking Credit Score...")
      155 +    await asyncio.sleep(2)  # Simulate external credit bureau API
      156 +
      157 +    # Simulate calculating DTI (processing step)
      158 +    print(f"[UnderwritingMCP] [{timestamp}] Calculating DTI...")
      159 +    await asyncio.sleep(2)  # Simulate DTI calculation with income verification
      160 +
      161 +    # Simulate final risk assessment (decision engine)
      162 +    print(f"[UnderwritingMCP] [{timestamp}] Running Risk Assessment Engine...")
      163 +    await asyncio.sleep(1)  # Simulate decision engine processing
      164 +
      165 +    print(f"[UnderwritingMCP] [{timestamp}] Risk Assessment Complete")
      166 +
      167 +    # Now perform the actual evaluation
      168      return UnderwritingMCP.evaluate_risk(loan_data)

● Now let me update the CEO workflow to add the Closing phase activities (Mission 4) - generate Final Approval Letter
  and send congratulations email:

● Update(backend\app\temporal\workflows\ceo.py)
  ⎿  Added 2 lines
      18      from app.models.sql import LoanStage
      19      from .managers import LeadCaptureWorkflow, ProcessingWorkflow, UnderwritingWorkflow
      20      from app.temporal.activities.mcp_encompass import update_loan_metadata
      21 +    from app.temporal.activities.mcp_docgen import generate_document
      22 +    from app.temporal.activities.mcp_comms import send_email
      23
      24
      25  @workflow.defn

● Now let me add the Final Approval Letter template to mcp_docgen.py:

● Update(backend\app\temporal\activities\mcp_docgen.py)
  ⎿  Added 35 lines
       62
       63  This estimate is valid for 10 business days.
       64  """,
       65 +    "Final Approval Letter": """
       66 +FINAL APPROVAL LETTER
       67 +
       68 +Date: {date}
       69 +
       70 +Dear {name},
       71 +
       72 +CONGRATULATIONS! YOUR LOAN HAS BEEN APPROVED!
       73 +=========================================================
       74 +
       75 +We are pleased to inform you that your mortgage loan
       76 +application has been approved and is now funded.
       77 +
       78 +LOAN DETAILS
       79 +---------------------------------------------------------
       80 +Property Value:      ${property_value:,.2f}
       81 +Down Payment:        ${down_payment:,.2f}
       82 +Loan Amount:         ${loan_amount:,.2f}
       83 +Interest Rate:       {rate}% Fixed
       84 +Loan Term:           {term} years
       85 +Monthly Payment:     ${monthly_payment:,.2f}
       86 +
       87 +NEXT STEPS
       88 +---------------------------------------------------------
       89 +1. Your funds have been disbursed
       90 +2. Your first payment is due in 30 days
       91 +3. You will receive your payment book shortly
       92 +
       93 +Thank you for choosing Moxi Mortgage!
       94 +
       95 +Best regards,
       96 +The Moxi Mortgage Team
       97 +
       98 +Equal Housing Lender. NMLS #12345
       99 +""",
      100  }
      101
      102

● Now let me update the CEO workflow to add the closing phase activities (generate Final Approval Letter and send
  congratulations email):

● Update(backend\app\temporal\workflows\ceo.py)
  ⎿  Added 45 lines
      298              start_to_close_timeout=timedelta(seconds=30)
      299          )
      300
      301 +        # Generate Final Approval Letter
      302 +        workflow.logger.info("CEO: Generating Final Approval Letter...")
      303 +        self._add_log("DocGen MCP", "Generating Final Approval Letter...")
      304 +
      305 +        applicant_info = self.loan_data.get("applicant_info", {})
      306 +        doc_data = {
      307 +            "workflow_id": workflow.info().workflow_id,
      308 +            "name": applicant_info.get("name", applicant_name),
      309 +            "email": applicant_info.get("email", ""),
      310 +            "property_value": self.loan_data.get("property_value", 0),
      311 +            "down_payment": self.loan_data.get("down_payment", 0),
      312 +            "loan_amount": self.loan_data.get("loan_amount", 0),
      313 +            "rate": 6.5,
      314 +            "term": 30
      315 +        }
      316 +
      317 +        approval_doc = await workflow.execute_activity(
      318 +            generate_document,
      319 +            args=["Final Approval Letter", doc_data, {}],
      320 +            start_to_close_timeout=timedelta(seconds=60)
      321 +        )
      322 +
      323 +        workflow.logger.info(f"Final Approval Letter generated: {approval_doc.get('public_url')}")
      324 +        self._add_log("DocGen MCP", f"Final Approval Letter generated: {approval_doc.get('public_url')
          +}")
      325 +
      326 +        # Send congratulations email
      327 +        applicant_email = applicant_info.get("email", "")
      328 +        if applicant_email:
      329 +            workflow.logger.info("CEO: Sending congratulations email...")
      330 +            self._add_log("Comms MCP", "Sending congratulations notification...")
      331 +
      332 +            await workflow.execute_activity(
      333 +                send_email,
      334 +                args=["loan_funded", applicant_email, {
      335 +                    "name": applicant_info.get("name", applicant_name),
      336 +                    "loan_amount": self.loan_data.get("loan_amount", 0),
      337 +                    "approval_letter_url": approval_doc.get("public_url"),
      338 +                    "subject": "Congratulations! Your Loan is Funded"
      339 +                }],
      340 +                start_to_close_timeout=timedelta(seconds=30)
      341 +            )
      342 +
      343 +            workflow.logger.info(f"Congratulations email sent to {applicant_email}")
      344 +            self._add_log("Comms MCP", f"Email sent to {applicant_email}: Congratulations! Your loan i
          +s funded")
      345 +
      346          # =========================================
      347          # Final: Archive Completed Loan
      348          # =========================================

● Let me verify all the changes are correct by reading the modified sections:

● Read(frontend\src\pages\ApplicantDashboard.jsx)
  ⎿  Read 80 lines

● Read(backend\app\temporal\workflows\managers.py)
  ⎿  Read 80 lines

● Read(backend\app\temporal\activities\mcp_underwriting.py)
  ⎿  Read 40 lines

● Read(backend\app\temporal\workflows\ceo.py)
  ⎿  Read 80 lines

● All changes look correct. Let me also verify the signature card section of the ApplicantDashboard to ensure the UX
  flow is complete:

● Read(frontend\src\pages\ApplicantDashboard.jsx)
  ⎿  Read 60 lines

● All four missions have been implemented. Here's a summary of the changes:

  Summary of Changes

  Mission 1: UX Fix - "Read before Signing"

  File: frontend/src/pages/ApplicantDashboard.jsx
  - Added hasViewed state to track whether user has viewed disclosures
  - Created handleViewDisclosures() function that opens PDF AND sets hasViewed = true
  - Updated the signature section:
    - Shows a "View Disclosures First" button (blue) that turns green ("Disclosures Viewed") after clicking
    - Sign button only appears after hasViewed is true
    - If user hasn't viewed, shows warning message: "Please View Disclosures First"

  Mission 2: Activate "Processing" Phase Tools

  File: backend/app/temporal/workflows/managers.py (ProcessingWorkflow)
  - Added send_email activity call after generate_document succeeds
  - Email template: disclosures_ready
  - Subject: "Action Required: Your Loan Disclosures are Ready"
  - Includes proper logging for audit trail

  Mission 3: Activate "Underwriting" Phase Tools

  File: backend/app/temporal/activities/mcp_underwriting.py
  - Modified evaluate_risk activity to add 5-second simulation with staged logging:
    - "Checking Credit Score..." (2 sec)
    - "Calculating DTI..." (2 sec)
    - "Running Risk Assessment Engine..." (1 sec)
    - "Risk Assessment Complete"

  Mission 4: Activate "Closing" Phase Tools

  Files:
  - backend/app/temporal/workflows/ceo.py - Added closing activities
  - backend/app/temporal/activities/mcp_docgen.py - Added "Final Approval Letter" template

  Activities added in closing phase:
  1. generate_document("Final Approval Letter") - Creates Final_Approval_Letter.pdf
  2. send_email("loan_funded") - Sends congratulations email with subject "Congratulations! Your Loan is Funded"
