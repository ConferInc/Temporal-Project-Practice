# ============================================================
# 1099-MISC.yaml â€” Complete extraction rules for 1099-MISC
# ============================================================
# Extracts all 17 required fields matching LOS structure
# ============================================================

document_type: "1099-MISC"
schema_version: "1.0"

rules:

  # ----------------------------------------------------------
  # PAYER INFORMATION
  # ----------------------------------------------------------
  # Capture the Payer block using the standard top-left position or "PAYER'S name" label
  # leveraging the specific 1099 layout structure.
  
  - id: payer_name_generic
    type: regex
    pattern: 'Miscellaneous\s*\n+([A-Z\s]+?)(?=\n)' # Look for name under "Miscellaneous" label
    group: 1
    key: "payerName"
    target_path: "deal.parties[0].self_employment[0].business_name"

  - id: payer_address_generic
    type: regex
    pattern: 'Miscellaneous\s*\n+[^\n]+\n+([^\n]+)' # Line below Name is typically Street
    group: 1
    target_path: "deal.parties[0].self_employment[0].business_address_street"

  - id: payer_tin
    type: regex
    pattern: 'PAYER''?S?\s?TIN\s*\n\s*(\d{2}-\d{7})'
    group: 1
    key: "payerTIN"
    target_path: "deal.parties[0].self_employment[0].business_tax_id"

  - id: payer_phone
    type: regex
    # Generic phone capture in Payer section
    pattern: 'PAYER''?S?.*?\n.*?(\d{3}-\d{3}-\d{4})'
    flags: [DOTALL]
    group: 1
    key: "payerPhone"
    target_path: "deal.parties[0].self_employment[0].business_phone"

  # ----------------------------------------------------------
  # RECIPIENT INFORMATION (Borrower)
  # ----------------------------------------------------------
  - id: recipient_name_generic
    type: regex
    # Capture text immediately under "RECIPIENT'S name"
    pattern: 'RECIPIENT''?S?\s?name\s*\n([^\n]+)'
    group: 1
    key: "recipientName"
    target_path: "deal.parties[0].individual.full_name"

  - id: recipient_tin
    type: regex
    pattern: 'RECIPIENT''?S?\s?TIN\s*\n\s*(\d{3}-\d{2}-\d{4})'
    group: 1
    key: "recipientTIN"
    target_path: "deal.parties[0].taxpayer_identifier"

  - id: recipient_address_block
    type: regex
    # Capture address lines under "Street address" label
    # Looks for: Street address ... \n <Line 1> \n City... \n <Line 2>
    pattern: 'Street\s*address\s*[^\n]*\n([^\n]+)\n(?:City[^\n]*\n)?([^\n]+)'
    flags: [DOTALL]
    groups:
      1: "deal.parties[0].addresses[0].street"
      2: "deal.parties[0].addresses[0].city_state_zip_raw"
    groups_keys:
      1: "recipientStreet"
      2: "recipientRegionRaw"

  # Refine City/State/Zip from the raw region string (e.g. "ATLANTA GA 30019")
  - id: recipient_city_state_zip_parse
    type: regex
    # Matches: City Name  State  Zip
    pattern: '([A-Za-z\s]+?)\s+([A-Z]{2})\s+(\d{5})'
    # We apply this to the full text but constrained by being after "Street address"? 
    # Or ideally, we'd process the `recipientRegionRaw` if the engine supported nested transforms.
    # Since it doesn't, we'll try a regex that anchors to the City label.
    pattern: 'City\s*or\s*town[^\n]*\n([A-Za-z\s]+?)\s+([A-Z]{2})\s+(\d{5})'
    groups:
      1: "deal.parties[0].addresses[0].city"
      2: "deal.parties[0].addresses[0].state"
      3: "deal.parties[0].addresses[0].postal_code"
    groups_keys:
      1: "recipientCity"
      2: "recipientState"
      3: "recipientZip"

  # ----------------------------------------------------------
  # INCOME BOXES (non_w2_income)
  # ----------------------------------------------------------
  
  # Box 1: Rents - Format: "1 Rents" then "$ 1450.00" (possibly on new lines, maybe hyphenated)
  # Box 1: Rents
  - id: box_1_rents
    type: regex
    pattern: '1\s*Rents(?:(?!\n\d).)*?\$?\s*(\d[\d,]*\.\d{2})'
    flags: [DOTALL]
    group: 1
    key: "rents"
    target_path: "deal.parties[0].income[0].non_w2_income.rents"
    transform: currency_to_float

  # Box 2: Royalties
  - id: box_2_royalties
    type: regex
    pattern: '2\s*Royalties(?:(?!\n\d).)*?\$?\s*(\d[\d,]*\.\d{2})'
    flags: [DOTALL]
    group: 1
    key: "royalties"
    target_path: "deal.parties[0].income[0].non_w2_income.royalties"
    transform: currency_to_float

  # Box 3: Other income
  - id: box_3_other_income
    type: regex
    pattern: '3\s*Other\s*income(?:(?!\n\d).)*?\$?\s*(\d[\d,]*\.\d{2})'
    flags: [DOTALL]
    group: 1
    key: "otherIncome"
    target_path: "deal.parties[0].income[0].non_w2_income.other"
    transform: currency_to_float

  # Box 10: Gross proceeds paid to an attorney
  - id: box_10_gross_proceeds_attorney
    type: regex
    pattern: '-?\s*10\s*Gross\s*proceeds\s*paid\s*to\s*an\s*attorney\s*\n(?:.*?\n)*?-\s*\$\s*([\d,]+\.?\d{0,2})'
    group: 1
    key: "grossProceedsAttorney"
    target_path: "deal.parties[0].income[0].non_w2_income.attorney_proceeds"
    transform: currency_to_float

  # ----------------------------------------------------------
  # TAX WITHHOLDING
  # ----------------------------------------------------------
  
  # Box 4: Federal income tax withheld
  - id: box_4_federal_tax_withheld
    type: regex
    pattern: '4\s*Federal\s*income\s*tax\s*withheld(?:(?!\n\d).)*?\$?\s*(\d[\d,]*\.\d{2})'
    flags: [DOTALL]
    group: 1
    key: "federalTaxWithheld"
    target_path: "deal.parties[0].taxes[0].federal_withheld_amount"
    transform: currency_to_float

  # Box 16: State tax withheld
  - id: box_16_state_tax_withheld
    type: regex
    pattern: '-?\s*16\s*State\s*tax\s*withheld\s*\n(?:.*?\n)*?-\s*\$\s*([\d,]+\.?\d{0,2})'
    group: 1
    key: "stateTaxWithheld"
    target_path: "deal.parties[0].taxes[0].state_withheld_amount"
    transform: currency_to_float

  # ----------------------------------------------------------
  # METADATA
  # ----------------------------------------------------------
  
  # Tax Year - Format: "Forcalendaryear 2025"
  - id: tax_year
    type: regex
    pattern: 'For\s*calendar\s*year\s*(\d{4})'
    group: 1
    key: "taxYear"
    target_path: "deal.parties[0].income_documents[0].tax_year"

  # Form Type
  - id: form_type
    type: static
    value: "1099-MISC"
    key: "formType"
    target_path: "deal.parties[0].income_documents[0].document_type"
